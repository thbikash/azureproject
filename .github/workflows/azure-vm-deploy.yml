name: Azure VM Bicep Deployment

on:
  push:
    branches:
      - main # Trigger on push to main branch
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy-vm:
    runs-on: ubuntu-latest # Uses the latest Ubuntu runner

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4 # Use v4 for the latest features and security fixes

      - name: Azure Login
        uses: azure/login@v2 # Authenticate to Azure
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} # Your Azure Service Principal credentials

      - name: Debug - List Files in VM directory (Optional, for troubleshooting)
        run: ls -l VM/

      - name: Deploy Azure VM using Bicep and Parameter File
        uses: azure/bicep-deploy@v1 # Using the dedicated bicep-deploy action (v1)
        with:
          type: 'deployment' # Specifies a standard ARM/Bicep deployment
          resource-group-name: RG-WebApplication # Your target Azure Resource Group
          template-file: ./VM/azuredeploycustomconfiguration.bicep # Path to your Bicep template

          # --- CORRECTED 'parameters' INPUT ---
          # Combine parameters from file and inline overrides.
          # The action will merge them, with inline values taking precedence.
          # Format it as a multi-line string for clarity and to easily combine.
          parameters: |
            @./VM/azuredeploycustomconfiguration.parameters.json # Reference the parameter file
            adminPassword=${{ secrets.VM_ADMIN_PASSWORD }} # Override password from GitHub Secret
            # Example of another inline override if needed:
            # vmName=myNewVMFromGHAction

          # --- REMOVED: 'additional-arguments' is NOT a valid input for this action ---
          # If you need --debug for the underlying AZ CLI command, it's not exposed
          # directly by this action as an input. You'd typically rely on the action's
          # internal logging.
          # additional-arguments: --debug # This line should be completely removed